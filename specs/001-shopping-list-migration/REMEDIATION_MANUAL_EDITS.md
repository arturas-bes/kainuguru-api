# Manual Remediation Edits

**Generated by**: `/speckit.analyze`
**Date**: 2025-11-15
**Status**: Requires manual application

This document contains the remaining CRITICAL and HIGH priority fixes that require manual editing after running `apply-fixes.sh`.

---

## Quick Start

1. **Run automated fixes first**:
   ```bash
   cd specs/001-shopping-list-migration
   ./apply-fixes.sh
   ```

2. **Then apply these manual edits** (copy-paste from sections below)

3. **Validate**:
   ```bash
   grep -c "internal/repository/" tasks.md  # Should be 0
   grep "Go 1.24" plan.md                    # Should match
   grep "0.0-1.0" spec.md                    # Should match FR-006
   ```

---

## C1: Error Handling Tasks (CRITICAL)

### Add to tasks.md Phase 2 (after T011, line ~49)

Insert these two new tasks:

```markdown
- [ ] T011a [P] Create wizard domain error types in pkg/errors/wizard_errors.go with ErrSessionExpired, ErrStaleData, ErrStoreLimit, ErrInvalidSession, ErrItemNotFound following pkg/errors.AppError interface
- [ ] T011b [P] Create error helper functions in pkg/errors/wizard_errors.go: WrapSessionError, WrapValidationError, WrapDataError for consistent error context wrapping
```

### Update Service Tasks with Error Handling

**Find T013 (line ~51), REPLACE entire line with:**
```markdown
- [ ] T013 Create SuggestionEngine service internal/services/suggestion_engine.go with CalculateScore and CalculateConfidence methods using deterministic scoring (brand: 3.0, store: 2.0, size: 1.0, price: 1.0), wrapping errors with pkg/errors at service layer, including NewSuggestionEngine(db, cache) and NewSuggestionEngineWithDeps(repo, logger) constructors per constitution service pattern
```

**Find T014 (line ~52), REPLACE entire line with:**
```markdown
- [ ] T014 [P] Create StoreSelector service internal/services/store_selector.go with greedy algorithm for 2-store optimization and ValidateStoreLimit method, using pkg/errors.ErrStoreLimit for limit violations, including NewStoreSelector(db) and NewStoreSelectorWithDeps(repo, logger) constructors per constitution service pattern
```

**Find T023 (line ~87), REPLACE entire line with:**
```markdown
- [ ] T023 [P] [US2] Create WizardService in internal/services/wizard_service.go with GenerateSuggestions method implementing two-pass search, wrapping all errors with pkg/errors.Wrap for context preservation, including NewWizardService(db, cache, searchService) and NewWizardServiceWithDeps(sessionRepo, offerRepo, searchService, suggestionEngine, logger) constructors per constitution service pattern
```

### Update Repository Tasks

**Find T009 (line ~47), APPEND to end:**
```markdown
, returning raw database errors without wrapping (wrapping occurs at service layer per constitution)
```

**Find T010 (line ~48), APPEND to end:**
```markdown
, returning raw database errors without wrapping (wrapping occurs at service layer per constitution)
```

**Find T011 (line ~49), APPEND to end:**
```markdown
, returning raw database errors without wrapping (wrapping occurs at service layer per constitution)
```

### Update GraphQL Resolver

**Find T015 (line ~53), REPLACE entire line with:**
```markdown
- [ ] T015 Create base GraphQL resolver internal/graphql/resolvers/wizard_resolver.go with resolver struct, dependencies injection, and errorhelper integration for converting pkg/errors to GraphQL errors
```

**For all mutation resolver tasks, APPEND:** `, using errorhelper.ToGraphQLError() for all error responses`
- T040 (startWizard mutation)
- T043 (recordDecision mutation)
- T050 (bulkAcceptSuggestions mutation)
- T057 (resumeWizard mutation)
- T064 (completeWizard mutation)
- T076 (wizardSessionUpdates subscription)
- T077 (expiredItemNotifications subscription)

---

## C7: Repository Generic Pattern (HIGH)

### Add to tasks.md Phase 2 (after T008, before T009)

Insert this new task:

```markdown
- [ ] T008a Create generic base repository in internal/repositories/base_repository.go with Repository[T] struct and CRUD methods (Create, Get, Update, Delete, List) using functional QueryOption pattern per constitution
```

### Update Repository Tasks

**Find T009, APPEND to end:**
```markdown
, extending Repository[WizardSession] base with domain-specific methods
```

**Find T010, APPEND to end:**
```markdown
, extending Repository[OfferSnapshot] base with domain-specific methods
```

**Find T011 (after previous C1 append), APPEND to end:**
```markdown
, extending Repository[UserMigrationPreferences] base with functional QueryOption filters
```

---

## C9: Shopping List Locking (HIGH)

### Add to tasks.md Phase 6 (after T042, before T043, line ~132)

Insert these two new tasks:

```markdown
- [ ] T042a [US4] Implement shopping list lock mechanism in internal/repositories/shopping_list_repo.go with AcquireLock(listID, sessionID) and ReleaseLock(listID, sessionID) methods using migration_session_id field for optimistic locking
- [ ] T042b [US4] Add lock validation to startWizard mutation to check if list is already locked by another session and return appropriate error
```

---

## U2: Dataset Version Tracking (MEDIUM - Recommended)

### Add to tasks.md Phase 1 (after T002, before T003, line ~30)

Insert these two new tasks:

```markdown
- [ ] T002a Add dataset_version INTEGER field to flyers table with migration, incrementing on each flyer update to enable staleness detection
- [ ] T002b Create database trigger or service method to auto-increment dataset_version on flyers table INSERT/UPDATE operations
```

### Update T058

**Find T058 (line ~174), REPLACE entire line with:**
```markdown
- [ ] T058 [US6] Add ValidateDatasetFreshness method to WizardService to compare session.datasetVersion with MAX(dataset_version) from flyers table, returning pkg/errors.ErrStaleData if mismatch detected
```

---

## Additional Recommended Fixes (MEDIUM Priority)

### U1: Distributed Lock Details

**Find T019 (line ~70), REPLACE entire line with:**
```markdown
- [ ] T019 [US1] Register FlyerExpirationWorker in worker scheduler with daily cron ("0 0 * * *") and Redis distributed locking using SETNX with key pattern 'lock:flyer-expiration' and 5-minute TTL with exponential backoff retry
```

### U3: Store Selection Tie-Breaking

**Find T053 (line ~158), REPLACE entire line with:**
```markdown
- [ ] T053 [US5] Integrate StoreSelector.OptimizeStoreSelection in BulkAccept to automatically select the 2 stores with most items (ties broken by lowest total price, then by user's preferred stores)
```

### A2: Price Increase Clarification

**Find T028 (line ~92), APPEND to end:**
```markdown
; 20% price increase threshold applies per individual product, not total basket
```

---

## Updated Task Count

After all additions:

- **Original**: 100 tasks
- **New error tasks**: +2 (T011a, T011b)
- **New repository task**: +1 (T008a)
- **New locking tasks**: +2 (T042a, T042b)
- **New dataset tasks**: +2 (T002a, T002b)
- **Total**: 107 tasks

---

## Validation Checklist

After applying all edits:

```bash
# Verify repository paths fixed
grep -c "internal/repository/" tasks.md
# Expected: 0

# Verify Go version
grep "Go 1.24" plan.md
# Expected: match

# Verify confidence range
grep "0.0-1.0 scale" spec.md
# Expected: match on FR-006

# Verify error handling tasks
grep "T011a\|T011b" tasks.md
# Expected: 2 matches

# Verify base repository task
grep "T008a" tasks.md
# Expected: 1 match

# Verify locking tasks
grep "T042a\|T042b" tasks.md
# Expected: 2 matches

# Verify dataset version tasks
grep "T002a\|T002b" tasks.md
# Expected: 2 matches

# Count total tasks
grep -c "^- \[ \] T[0-9]" tasks.md
# Expected: 107
```

---

## Alternative: Use Pre-Fixed Files

If you prefer to replace files entirely instead of manual editing:

The remediation has generated:
- `plan.md.fixed` - Complete updated plan
- `spec.md.fixed` - Complete updated spec
- For tasks.md: Follow this document OR regenerate via `/speckit.tasks`

To use pre-fixed files:
```bash
mv plan.md plan.md.old
mv plan.md.fixed plan.md

mv spec.md spec.md.old
mv spec.md.fixed spec.md

# For tasks.md, apply manual edits from this document
```

---

## Summary

**Automated** (via apply-fixes.sh):
- ✅ Go 1.24+ version
- ✅ Repository path corrections
- ✅ Confidence score range
- ✅ Testing exception documentation

**Manual** (this document):
- ⚠️ Error handling (C1): 2 new tasks + 12 task updates
- ⚠️ Constructor patterns (C6): 3 task updates (merged with C1)
- ⚠️ Repository patterns (C7): 1 new task + 3 task updates
- ⚠️ List locking (C9): 2 new tasks
- ⚠️ Dataset versioning (U2): 2 new tasks + 1 task update
- ⚠️ Misc improvements: 3 task updates

**Total work**: ~25-30 minutes of careful copy-paste and verification

